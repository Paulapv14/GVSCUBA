<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G.V. Scuba - Sistema POS 2025</title>
    <style>
        :root {
            --primary: #0277bd;
            --secondary: #004c8c;
            --accent: #ff9800;
            --bg: #f4f6f8;
            --text: #333;
            --white: #ffffff;
            --danger: #d32f2f;
            --success: #388e3c;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: var(--bg); color: var(--text); }
        
        /* Layout */
        header { background-color: var(--secondary); color: var(--white); padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        
        /* Vistas */
        .screen { display: none; }
        .active { display: block; }

        /* Login */
        .login-box {
            background: var(--white); width: 300px; margin: 100px auto; padding: 30px;
            border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;
        }
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}
        button { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-size: 1rem; transition: 0.3s;}
        button:hover { opacity: 0.9; }
        .btn-danger { background-color: var(--danger); }
        .btn-secondary { background-color: #78909c; }
        .btn-accent { background-color: var(--accent); color: white;}

        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
        .card-menu { background: var(--white); padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card-menu:hover { transform: translateY(-5px); border-bottom: 4px solid var(--accent); }
        .card-icon { font-size: 2rem; margin-bottom: 10px; display: block; }

        /* POS Layout */
        .pos-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .catalog-section { overflow-y: auto; max-height: 80vh; }
        
        /* Estilos de Tablas y Listas */
        .cart-panel { background: var(--white); padding: 20px; border-radius: 8px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; }
        th { background-color: #f5f5f5; }
        
        /* Corte de Caja Cards */
        .summary-cards { display: flex; gap: 20px; margin-bottom: 20px; }
        .summary-card { flex: 1; padding: 20px; border-radius: 8px; color: white; text-align: center; }
        .bg-in { background-color: var(--success); }
        .bg-out { background-color: var(--danger); }
        .bg-total { background-color: var(--secondary); }
        .big-number { font-size: 2rem; font-weight: bold; display: block; }

        /* Utilidades */
        .hidden { display: none; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; color: white; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; }
        .badge-venta { background-color: var(--success); }
        .badge-gasto { background-color: var(--danger); }
        
        /* Filtros y Productos */
        .filters { margin-bottom: 20px; display: flex; gap: 5px; flex-wrap: wrap;}
        .filter-btn { width: auto; background: #e0e0e0; color: #333; font-size: 0.9rem; padding: 5px 15px;}
        .filter-btn.active-filter { background: var(--primary); color: white; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .product-card { background: white; padding: 15px; border: 1px solid #eee; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
        .add-btn { margin-top: 10px; }

        /* Referencia Bancaria */
        .ref-input-group { background: #e3f2fd; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #90caf9; }
        .ref-label { font-size: 0.8rem; font-weight: bold; color: #1565c0; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <div class="login-box">
            <h2 style="color: var(--primary);">G.V. Scuba</h2>
            <p>Sistema POS 2025</p>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="login-user" placeholder="Usuario" required>
                <input type="password" id="login-pass" placeholder="Contrase√±a" required>
                <button type="submit">Iniciar Sesi√≥n</button>
            </form>
            <div style="font-size: 0.8rem; color: #666; margin-top: 15px; text-align: left; background: #f9f9f9; padding: 10px; border-radius: 5px;">
                <strong>Usuarios:</strong><br>
                User: <b>gerente</b> | Pass: <b>123</b><br>
                User: <b>cajero</b> &nbsp;| Pass: <b>123</b>
            </div>
        </div>
    </div>

    <div id="main-app" class="screen">
        <header>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="background: white; width: 30px; height: 30px; border-radius: 50%; display:flex; align-items:center; justify-content:center; color: var(--primary); font-weight:bold;">GV</div>
                <h3>G.V. Scuba POS</h3>
            </div>
            <div>
                <span id="user-display">Usuario: ...</span> | 
                <button onclick="logout()" style="width: auto; padding: 5px 10px; background: transparent; border: 1px solid white; font-size: 0.8rem;">Salir</button>
            </div>
        </header>

        <div class="container">
            
            <div id="dashboard-view">
                <h2>Men√∫ Principal</h2>
                <div class="dashboard-grid">
                    <div class="card-menu" onclick="switchView('pos-view')">
                        <span class="card-icon">üõí</span>
                        <h3>Venta / Servicios</h3>
                        <p>Registro de ingresos</p>
                    </div>
                    <div class="card-menu" onclick="switchView('egresos-view')">
                        <span class="card-icon">üí∏</span>
                        <h3>Registrar Egresos</h3>
                        <p>Salidas de caja y gastos</p>
                    </div>
                    <div class="card-menu" onclick="generateCorte()">
                        <span class="card-icon">üì†</span>
                        <h3>Corte de Caja</h3>
                        <p>Balance del d√≠a</p>
                    </div>
                    <div class="card-menu gerente-only" onclick="switchView('users-view')">
                        <span class="card-icon">üë•</span>
                        <h3>Usuarios</h3>
                        <p>Administraci√≥n</p>
                    </div>
                </div>
            </div>

            <div id="pos-view" class="hidden">
                <button class="btn-secondary" onclick="switchView('dashboard-view')" style="width: auto; margin-bottom: 20px;">&larr; Volver</button>
                
                <div class="pos-layout">
                    <div class="catalog-section">
                        <div class="filters">
                            <button class="filter-btn active-filter" onclick="filterProducts('all', this)">Todos</button>
                            <button class="filter-btn" onclick="filterProducts('pruebas', this)">Pruebas</button>
                            <button class="filter-btn" onclick="filterProducts('aire', this)">Aire</button>
                            <button class="filter-btn" onclick="filterProducts('mantenimiento', this)">Mant.</button>
                        </div>
                        <div id="products-container" class="products-grid"></div>
                    </div>

                    <div class="cart-panel">
                        <h3>Ticket Actual</h3>
                        <div id="cart-list" style="min-height: 150px; margin-bottom:10px;"></div>
                        <div style="border-top: 1px solid #eee; padding-top:10px;">
                            <div style="display:flex; justify-content:space-between;"><span>Subtotal:</span> <span id="lbl-subtotal">$0.00</span></div>
                            <div style="display:flex; justify-content:space-between;"><span>IVA (16%):</span> <span id="lbl-tax">$0.00</span></div>
                            <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.2rem; margin-top:5px;"><span>Total:</span> <span id="lbl-total">$0.00</span></div>
                        </div>
                        
                        <div style="margin-top: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                            <label style="font-weight:bold; display:block; margin-bottom:5px;">Nombre del Cliente:</label>
                            <input type="text" id="client-name" placeholder="Ej: Juan P√©rez" style="margin:0;">
                        </div>

                        <div style="margin-top: 15px;">
                            <label style="font-weight:bold;">M√©todo de Pago:</label>
                            <select id="payment-method" onchange="toggleRefInput()">
                                <option value="Efectivo">Efectivo</option>
                                <option value="Transferencia">Transferencia</option>
                                <option value="Tarjeta">Tarjeta D√©bito/Cr√©dito</option>
                                <option value="Cheque">Cheque</option>
                            </select>
                        </div>

                        <div id="ref-container" class="ref-input-group hidden">
                            <label class="ref-label">N√∫mero de Referencia / Folio (Solo N√∫meros):</label>
                            <input type="text" id="payment-ref" placeholder="Ej: 4589" style="margin:0;" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                        </div>

                        <button class="btn-accent" style="margin-top: 15px;" onclick="processSale()">COBRAR</button>
                    </div>
                </div>
            </div>

            <div id="egresos-view" class="hidden">
                <button class="btn-secondary" onclick="switchView('dashboard-view')" style="width: auto; margin-bottom: 20px;">&larr; Volver</button>
                <div style="max-width: 500px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px;">
                    <h2 style="color: var(--danger);">Registrar Salida de Dinero</h2>
                    <p>Ingrese los detalles del gasto o retiro de caja.</p>
                    
                    <label>Monto a retirar ($):</label>
                    <input type="number" id="expense-amount" placeholder="0.00" min="0" step="0.50">
                    
                    <label>Motivo / Descripci√≥n:</label>
                    <textarea id="expense-desc" rows="3" placeholder="Ej: Compra de art√≠culos de limpieza, pago de proveedor..."></textarea>
                    
                    <button class="btn-danger" onclick="saveExpense()">Registrar Egreso</button>
                </div>
            </div>

            <div id="corte-view" class="hidden">
                <button class="btn-secondary" onclick="switchView('dashboard-view')" style="width: auto; margin-bottom: 20px;">&larr; Volver</button>
                <h2>Corte de Caja (Turno Actual)</h2>
                
                <div class="summary-cards">
                    <div class="summary-card bg-in">
                        <span>Ingresos (Ventas)</span>
                        <span class="big-number" id="corte-ingresos">$0.00</span>
                    </div>
                    <div class="summary-card bg-out">
                        <span>Egresos (Gastos)</span>
                        <span class="big-number" id="corte-egresos">$0.00</span>
                    </div>
                    <div class="summary-card bg-total">
                        <span>Balance en Caja</span>
                        <span class="big-number" id="corte-balance">$0.00</span>
                    </div>
                </div>

                <h3>Movimientos Registrados</h3>
                <div style="background: white; border-radius: 8px; overflow: hidden; border: 1px solid #eee;">
                    <table id="corte-table">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Cliente</th> <th>Tipo</th>
                                <th>Descripci√≥n / Ref</th>
                                <th>Usuario</th>
                                <th>Monto</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <button onclick="window.print()" style="margin-top: 20px; width: auto; background: #333;">üñ®Ô∏è Imprimir Reporte</button>
            </div>

            <div id="users-view" class="hidden">
                <button class="btn-secondary" onclick="switchView('dashboard-view')" style="width: auto; margin-bottom: 20px;">&larr; Volver</button>
                <h2>Gesti√≥n de Usuarios</h2>
                <div class="users-layout" style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                    <div style="background: white; padding: 20px; height: fit-content;">
                        <h3>Nuevo Usuario</h3>
                        <input type="text" id="new-user-name" placeholder="Nombre">
                        <input type="password" id="new-user-pass" placeholder="Contrase√±a">
                        <select id="new-user-role"><option value="cajero">Cajero</option><option value="gerente">Gerente</option></select>
                        <button onclick="addNewUser()">Agregar</button>
                    </div>
                    <div style="background: white; padding: 20px;">
                        <h3>Lista de Usuarios</h3>
                        <table id="users-table"><thead><tr><th>User</th><th>Rol</th><th>Acci√≥n</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- DATOS EXACTOS ---
        const products = [
            { id: 101, name: "Prueba Hidro c/Visual (SCUBA/SCBA)", category: "pruebas", price: 990.00 },
            { id: 102, name: "Prueba Hidro c/Visual (Ox√≠geno)", category: "pruebas", price: 580.00 },
            { id: 103, name: "Prueba s/Vis Ind. (Chico <30x30)", category: "pruebas", price: 850.00 },
            { id: 104, name: "Prueba s/Vis Ind. (Grande >30x30)", category: "pruebas", price: 990.00 },
            { id: 105, name: "Prueba s/Vis (No Resp.)", category: "pruebas", price: 400.00 },
            { id: 201, name: "Carga Aire 2,216 PSI", category: "aire", price: 420.00 },
            { id: 202, name: "Carga Aire 3,000 PSI", category: "aire", price: 450.00 },
            { id: 203, name: "Carga Gotcha (3,000 PSI)", category: "aire", price: 300.00 },
            { id: 204, name: "Carga Aire 4,500 PSI", category: "aire", price: 520.00 },
            { id: 205, name: "Carga Gotcha (4,500 PSI)", category: "aire", price: 350.00 },
            { id: 206, name: "Carga Eq. Mayor >80 pies (2500 PSI)", category: "aire", price: 1200.00 },
            { id: 207, name: "Carga Eq. Mayor >80 pies (+3000 PSI)", category: "aire", price: 1450.00 },
            { id: 301, name: "Revisi√≥n Equipo SCBA", category: "mantenimiento", price: 1800.00 },
            { id: 302, name: "Mantenimiento Regulador", category: "mantenimiento", price: 650.00 },
            { id: 303, name: "Lavado de Tanques", category: "mantenimiento", price: 300.00 }
        ];

        let systemUsers = [
            { id: 1, username: 'gerente', password: '123', role: 'gerente' },
            { id: 2, username: 'cajero', password: '123', role: 'cajero' }
        ];

        let transactionLog = []; 
        let cart = [];
        let currentUser = null;

        // --- LOGIN ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('login-user').value.toLowerCase().trim();
            const p = document.getElementById('login-pass').value;
            const found = systemUsers.find(user => user.username === u && user.password === p);
            
            if (found) {
                currentUser = found;
                document.getElementById('login-screen').classList.remove('active');
                document.getElementById('main-app').classList.add('active');
                document.getElementById('user-display').innerText = `${currentUser.username.toUpperCase()} (${currentUser.role})`;
                
                if(currentUser.role !== 'gerente') {
                    document.querySelectorAll('.gerente-only').forEach(el => el.style.display = 'none');
                } else {
                    document.querySelectorAll('.gerente-only').forEach(el => el.style.display = 'block');
                }

                renderProducts('all');
                renderUserTable();
                switchView('dashboard-view');
            } else {
                alert("Credenciales incorrectas.");
            }
        }

        function logout() { location.reload(); }

        function switchView(viewId) {
            document.querySelectorAll('.screen > .container > div').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        // --- POS ---
        function getCategoryColor(cat) {
            switch(cat) {
                case 'pruebas': return '#1976D2'; 
                case 'aire': return '#388E3C';    
                case 'mantenimiento': return '#F57C00'; 
                default: return '#757575';
            }
        }

        function renderProducts(cat) {
            const container = document.getElementById('products-container');
            container.innerHTML = '';
            const list = (cat === 'all') ? products : products.filter(p => p.category === cat);
            
            list.forEach(p => {
                const color = getCategoryColor(p.category);
                container.innerHTML += `
                    <div class="product-card">
                        <div>
                            <span class="badge" style="background:${color}">${p.category}</span> 
                            <h4 style="margin-top:10px; font-size:0.95rem;">${p.name}</h4>
                        </div>
                        <div>
                            <div style="font-size:1.2rem; font-weight:bold; color:var(--primary)">$${p.price.toFixed(2)}</div>
                            <button class="add-btn" onclick="addToCart(${p.id})">Agregar</button>
                        </div>
                    </div>`;
            });
        }

        function filterProducts(cat, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active-filter'));
            btn.classList.add('active-filter');
            renderProducts(cat);
        }

        function addToCart(id) {
            const item = products.find(p => p.id === id);
            cart.push(item);
            updateCart();
        }

        function updateCart() {
            const list = document.getElementById('cart-list');
            list.innerHTML = '';
            let sub = 0;
            if(cart.length === 0) list.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px">Carrito vac√≠o</p>';
            
            cart.forEach((item, idx) => {
                sub += item.price;
                list.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px dotted #eee;">
                    <span style="font-size:0.9rem;">${item.name}</span>
                    <span>$${item.price} <a href="#" onclick="cart.splice(${idx},1);updateCart()" style="color:red; text-decoration:none">&times;</a></span>
                </div>`;
            });

            const tax = sub * 0.16;
            document.getElementById('lbl-subtotal').innerText = `$${sub.toFixed(2)}`;
            document.getElementById('lbl-tax').innerText = `$${tax.toFixed(2)}`;
            document.getElementById('lbl-total').innerText = `$${(sub + tax).toFixed(2)}`;
        }

        function toggleRefInput() {
            const method = document.getElementById('payment-method').value;
            const refContainer = document.getElementById('ref-container');
            if (method === 'Transferencia' || method === 'Tarjeta' || method === 'Cheque') {
                refContainer.classList.remove('hidden');
                document.getElementById('payment-ref').focus();
            } else {
                refContainer.classList.add('hidden');
            }
        }

        function processSale() {
            if(cart.length === 0) return alert("El carrito est√° vac√≠o.");
            
            // 1. Obtener datos
            const client = document.getElementById('client-name').value.trim() || "P√∫blico General"; // Valor por defecto
            let sub = cart.reduce((acc, item) => acc + item.price, 0);
            let tax = sub * 0.16;
            let total = sub + tax;
            let method = document.getElementById('payment-method').value;
            
            // 2. Validaci√≥n de referencia (Solo N√∫meros)
            let ref = "";
            if (method !== 'Efectivo') {
                ref = document.getElementById('payment-ref').value.trim();
                if (ref.length < 1) { // Al menos un n√∫mero
                    return alert(`‚ö†Ô∏è Para pagos con ${method} es obligatorio ingresar la referencia num√©rica.`);
                }
                ref = ` (Ref: ${ref})`;
            }

            if(confirm(`Cliente: ${client}\nTotal: $${total.toFixed(2)}\nM√©todo: ${method}${ref}\n\n¬øProcesar venta?`)) {
                transactionLog.push({
                    type: 'venta', 
                    client: client, // Guardamos cliente
                    desc: `Venta POS${ref}`,
                    amount: total,
                    user: currentUser.username,
                    method: method,
                    time: new Date().toLocaleTimeString()
                });

                alert("‚úÖ Venta registrada correctamente.");
                cart = [];
                document.getElementById('payment-ref').value = '';
                document.getElementById('client-name').value = ''; // Limpiar nombre cliente
                toggleRefInput();
                updateCart();
                switchView('dashboard-view');
            }
        }

        // --- EGRESOS ---
        function saveExpense() {
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const desc = document.getElementById('expense-desc').value;

            if(!amount || amount <= 0 || !desc) return alert("Ingrese monto y descripci√≥n.");

            transactionLog.push({
                type: 'gasto',
                client: '-', // No aplica cliente en egreso
                desc: desc,
                amount: amount,
                user: currentUser.username,
                method: 'Efectivo',
                time: new Date().toLocaleTimeString()
            });

            alert(`‚úÖ Egreso registrado.`);
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-desc').value = '';
            switchView('dashboard-view');
        }

        // --- CORTE DE CAJA ---
        function generateCorte() {
            let totalIngresos = 0;
            let totalEgresos = 0;
            const tbody = document.querySelector('#corte-table tbody');
            tbody.innerHTML = '';

            transactionLog.forEach(tx => {
                if(tx.type === 'venta') totalIngresos += tx.amount;
                if(tx.type === 'gasto') totalEgresos += tx.amount;

                const badgeClass = tx.type === 'venta' ? 'badge-venta' : 'badge-gasto';
                const sign = tx.type === 'venta' ? '+' : '-';
                const color = tx.type === 'venta' ? 'green' : 'red';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${tx.time}</td>
                        <td style="font-weight:bold;">${tx.client}</td> <td><span class="badge ${badgeClass}">${tx.type}</span></td>
                        <td>${tx.desc}</td>
                        <td>${tx.user}</td>
                        <td style="color:${color}; font-weight:bold;">${sign} $${tx.amount.toFixed(2)}</td>
                    </tr>
                `;
            });

            const balance = totalIngresos - totalEgresos;
            document.getElementById('corte-ingresos').innerText = `$${totalIngresos.toFixed(2)}`;
            document.getElementById('corte-egresos').innerText = `$${totalEgresos.toFixed(2)}`;
            document.getElementById('corte-balance').innerText = `$${balance.toFixed(2)}`;
            switchView('corte-view');
        }

        // --- USUARIOS ---
        function renderUserTable() {
            const tb = document.querySelector('#users-table tbody');
            tb.innerHTML = '';
            systemUsers.forEach(u => {
                tb.innerHTML += `<tr><td>${u.username}</td><td>${u.role}</td><td><button onclick="delUser(${u.id})">x</button></td></tr>`;
            });
        }
        function addNewUser() {
            const n = document.getElementById('new-user-name').value;
            const p = document.getElementById('new-user-pass').value;
            const r = document.getElementById('new-user-role').value;
            if(n && p) {
                systemUsers.push({id: Date.now(), username: n, password: p, role: r});
                renderUserTable();
                alert("Usuario creado");
            }
        }
        function delUser(id) {
            if(id === 1) return alert("No borrar admin");
            systemUsers = systemUsers.filter(u => u.id !== id);
            renderUserTable();
        }
    </script>
</body>
</html>